%YAML 1.1
--- 
StructureVersion: "1.0"
Properties: 
  RUID: 209316035_2119495691
  Name: "TEServer. Экспорт остатков  в КС"
  Caption: "TEServer. Экспорт остатков  в КС"
  Version: "1.0.0.15"
  Optional: False
  Internal: True
  MD5: CC81B61CC922CD5C87613140D4C44202
Uses: 
  - "148919179_537677461 GS.Общее.Деноминация 2016"
  - "199348208_2100852545 переоценка_2015"
Objects: 
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147020216_281066798
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 209316185_2119495691
    Fields: 
      NAME: "ecr_TEServer_Waiting"
      COMMENT: ~
      EVENT: ~
      FUNCTIONTYPE: ~
      GROUPNAME: ~
      INHERITEDRULE: 0
      LANGUAGE: "VBScript"
      LOCALNAME: ~
      MODIFYDATE: ~
      MODULE: "UNKNOWN"
      MODULECODE: "1010001_17 APPLICATION"
      OBJECTNAME: "APPLICATION"
      OWNERNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      USEDEBUGINFO: ~
      EDITIONDATE: 2019-01-04T11:50:11+03:00
      DISPLAYSCRIPT: | 
        ECR_TESERVER_WAITING
        
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QGAAAAUVJZRE9DBgAAAFFSWURPQwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        UFJTVA0AAABDRURFU0NSSVBUSU9ODQAAAENFREVTQ1JJUFRJT04AAAAAAAAAAAAAAAAAAAAAAAAA
        AAAAAAAARk5TVEZMUFI=
      SCRIPT: | 
        option explicit
        function ecr_TEServer_Waiting(ByRef qryDoc, ByRef ceDescription)
        ' ожидание обработки запроса TEServer'ом
        ' возвращает код ошибки (и описание в ceDescription)
        
          ecr_TEServer_Waiting = ecr_TEServer_ceOK
        
          on error resume next
          qryDoc.ExecSQL
            if err.number <> 0 then
            ecr_TEServer_Waiting = ecr_TEServer_ceServer
            ceDescription = err.Description + vbCR + _
              "Возможно, не запущен кассовый сервер № " + CStr(ecr_TEServer_ServerID) + "."
          end if
          on error goto 0
          if ecr_TEServer_Waiting <> ecr_TEServer_ceOK then exit function
        
          WinAPI.Sleep(1500)         ' ждем опроса TEServer'а
        
          qryDoc.SQL = "SELECT * FROM " + ecr_TEServer_FullCommandFileName
          do while True
            qryDoc.Open
            qryDoc.Last ' _теоретически_ записей м.б. несколько - проверяем последнюю
        
            ' все успешно обработалось - выходим
            if qryDoc.FieldByName("FLAG").AsInteger = 1 then
              ecr_TEServer_Waiting = ecr_TEServer_ceOK
              exit do
        
            ' обработка в процессе - ждем дальше
            elseif qryDoc.FieldByName("FLAG").AsInteger = 2 then
              qryDoc.Close
              WinAPI.Sleep(1000)      ' ждем дальше
        
            ' предполагаем, что не запущен сервер
            elseif qryDoc.FieldByName("FLAG").AsInteger = 0 then
              ecr_TEServer_Waiting = ecr_TEServer_ceServer
              ceDescription = "Не запущен кассовый сервер № " + CStr(ecr_TEServer_ServerID) + "."
              exit do
        
            ' произошла ошибка
            elseif qryDoc.FieldByName("FLAG").AsInteger = 9 then
              ecr_TEServer_Waiting = ecr_TEServer_ceError
              ceDescription = qryDoc.FieldByName("INFO").AsString
              exit do
            end if
        
          loop
          qryDoc.Close
        
          ' удаляем запись из command.dbf
          qryDoc.SQL = "DELETE FROM " + ecr_TEServer_FullCommandFileName
          qryDoc.ExecSQL
        
        end function
        
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147006692_122479781
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 209316185_2119495691
    Fields: 
      NAME: "ecr_ZServer_CreateTable"
      COMMENT: ~
      EVENT: ~
      FUNCTIONTYPE: ~
      GROUPNAME: ~
      INHERITEDRULE: 0
      LANGUAGE: "VBScript"
      LOCALNAME: ~
      MODIFYDATE: ~
      MODULE: "UNKNOWN"
      MODULECODE: "1010001_17 APPLICATION"
      OBJECTNAME: "APPLICATION"
      OWNERNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      USEDEBUGINFO: ~
      EDITIONDATE: 2022-02-23T20:03:16+03:00
      DISPLAYSCRIPT: | 
        ECR_ZSERVER_CREATETABLE
        
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QKAAAAQVRBQkxFVFlQRQsAAADS6O8g8uDh6+j2+wAAAAAAAAAAAAAAAAAAAAAAAAAA
        AAAAAABGTlNURkxQUg==
      SCRIPT: | 
        ' создает таблицы для обмена данными
        function ecr_ZServer_CreateTable(aTableType)
        
          set gsql = CreateObject("gsdbquery.gsdb_rpQueryList")
          set qryDoc = gsql.Query(gsql.Add("qryDoc", 0))
        
          select case aTableType
          
            case 0    ' справочник кодов
              qryDoc.SQL = "CREATE TABLE '" +_
              ecr_TEServer_workpath + ecr_TEServer_Ref_Filename + "' " + _
              " (SECTIONID CHAR(4), " + _
              "  PLU CHAR(18), " + _
              "  PLUNAME CHAR(60), " + _
              "  PRICE NUMERIC(13, 2), " + _
              "  DEPARTMENT NUMERIC(2, 0), " + _
              "  DISCOUNT NUMERIC(6, 2), " + _
              "  Q NUMERIC(13, 3), " + _
              "  SQ NUMERIC(5, 3), " + _
              "  DQ NUMERIC(6, 3), " + _
              "  LOCKPLU BOOLEAN) "
        
            case 1    ' условие для выборки "истории продаж с выборкой по условию"
              qryDoc.SQL = "CREATE TABLE '" + _
              ecr_TEServer_workpath + ecr_TEServer_Sell_Filename + "' " + _
              " (SECTIONID CHAR(4), " + _
              "  PLU CHAR(18), " + _
              "  FROMDATE DATE, " + _
              "  TODATE DATE ) "
        
        '    case 2
        
        'sectionId	Character	4	Номер секции, которой принадлежит код товара
        'plu	Character	18	Код товара
        
          end select
          qryDoc.ExecSQL
        
        end  function
        
  - 
    Properties: 
      Class: "TgdcDelphiObject"
      RUID: 147014649_23783130
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 209316185_2119495691
    Fields: 
      PARENT: ~
      NAME: "gdc_frmInvViewRemains147025940_63934951"
      CLASSNAME: ""
      DESCRIPTION: ~
      MACROSGROUPKEY: "147014662_23783130 Локальные макросы"
      OBJECTNAME: "gdc_frmInvViewRemains147025940_63934951"
      OBJECTTYPE: 0
      REPORTGROUPKEY: "147014663_23783130 Отчеты(gdc_frmInvViewRemains147025940_63934951)"
      SUBTYPE: ""
      EDITIONDATE: 2003-09-24T17:23:15+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 209316185_2119495691
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      NAME: "Export_Remains_at_Tserver_ADO"
      COMMENT: ~
      EVENT: ~
      FUNCTIONTYPE: ~
      GROUPNAME: ~
      INHERITEDRULE: 0
      LANGUAGE: "VBScript"
      LOCALNAME: ~
      MODIFYDATE: ~
      MODULE: "MACROS"
      MODULECODE: "147014649_23783130 gdc_frmInvViewRemains147025940_63934951"
      OBJECTNAME: "gdc_frmInvViewRemains147025940_63934951"
      OWNERNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      USEDEBUGINFO: 0
      EDITIONDATE: 2022-02-25T18:01:03+03:00
      DISPLAYSCRIPT: | 
        EXPORT_REMAINS_AT_TSERVER_ADO
        TM_WORK
        CREATE_OR_DELETE_DBF
        CRE_DBF
        DEL_DBF
        INSERT_INTO_FFN_1
        GET_REMAINS_SQL
        COPY_DBF_TEMP
        PROGRESSFORMREM
        
      ENTEREDPARAMS: ~
      SCRIPT: | 
        '#include TWG_PROGRESSFORM
        '#include ECR_TESERVER_WAITING_ADO
        '#include GS_DNMNTODIVIDE
        '#include ecr_DeptList
        '#include ecr_ZServer_SetParams
        '#include ecr_TEServer_Waiting
        '#include ecr_ZServer_CreateTable
        
        sub Export_Remains_at_Tserver_ADO
        
          dim ParamList, ParamWindow, ParamIndex, depart, result , tempParam
           ' Создание диалога
          set ParamWindow = System.GetNewParamWindow(0)
           ' Присвоим список параметров отдельной переменной
          set ParamList = ParamWindow.ParamList
           ' Добавление параметра через объект-диалог
        
          call ParamWindow.AddLinkParam("Подразделение", "prmLinkElement", "GD_CONTACT gg1", "id", "name", "gg1.contacttype =4 and EXISTS (SELECT con.id FROM gd_contact con where con.lb <= gg1.lb and con.rb >=gg1.rb and con.id = "+CStr(IBLogin.CompanyKey)+")" , "", "Выбор типа лимита")
          ParamList.Params(0).Required = false
        
          ' Отображение диалога и получение результата
          result = ParamWindow.ExecuteWithParamList(ParamList)
        
          if IsEmpty(result) then
             exit sub
          end if
        
           depart = result(0)
        
        
        ' Передать товары в кассу (TEServer) из остатков
          set Creator = New TCreator
          set gdcDocLine = Creator.GetObject(nil, "TIBDataSet", "")
          gdcDocLine.Transaction = gdcBaseManager.ReadTransaction
          gdcDocLine.Close
          gdcDocLine.SelectSQL.Text = get_remains_SQL(depart)
        
          dim ibSQL, DepName
          set ibSQL  = Creator.GetObject(nil,"TIBSQL", "")
          ibSQL.Transaction = gdcBaseManager.ReadTransaction
        ' имя подразделения, по которому выбираем остатки
          IF depart(0)>-1 then
            ibSQL.Close
            ibSQL.SQL.Text = _
              "SELECT NAME FROM GD_CONTACT WHERE ID = " & depart(0)
            ibSQL.ExecQuery
            DepName = ibSQL.FieldByName("NAME").asString
          else
            DepName = "Вcе товары ШТРИХ-КОД"
          end if
        
          ' пути для работы с ЛОГ файлами
          dim ecr_TEServer_path_Log
          ecr_TEServer_path_Log = "d:\Temp\"
        
          'Прогресс бар
          dim prForm, TmS, TmE, TmSum
          TmS = Time
          set prForm = New Twg_ProgressForm
          call prForm.Init(prForm, Null)
          prForm.Caption = "Экспорт остатков: " & DepName
          prForm.Note = "Идет передача..."
        
        
          ecr_CriticalError = ecr_TEServer_ceOK
          ecr_ZServer_SetParams(ecr_TEServer_ttToCass)
        
          FullFileName = ecr_TEServer_workpath + ecr_TEServer_Ref_Filename
          ''''''''''
          FFName = Split(ecr_TEServer_Ref_Filename,".")
          FF_N =FFName(0)
        
          ' для работы с сетевыми ДБФ
          dim ObjCon
          set ObjCon = CreateObject("ADODB.Connection")
          ObjCon.Provider = "Microsoft.Jet.OLEDB.4.0"
          ObjCon.Properties("Data Source") = ecr_TEServer_workpath
          ObjCon.Properties("Jet OLEDB:Engine Type") = 18
          ObjCon.Open
          
          dim objADOQuery
          set objADOQuery = CreateObject("ADODB.Command")
          objADOQuery.ActiveConnection = ObjCon
          
          ' для работы с локальными ДБФ
          dim ObjConLoc
          set ObjConLoc = CreateObject("ADODB.Connection")
          ObjConLoc.Provider = "Microsoft.Jet.OLEDB.4.0"
          ObjConLoc.Properties("Data Source") = ecr_TEServer_workpath_local
          ObjConLoc.Properties("Jet OLEDB:Engine Type") = 18
          ObjConLoc.Open
          
          dim objADOQueryLoc
          set objADOQueryLoc = CreateObject("ADODB.Command")
          objADOQueryLoc.ActiveConnection = ObjConLoc
          
        
          dim AdoQuery
          set AdoQuery = CreateObject("ADODB.RecordSet")
          AdoQuery.ActiveConnection = ObjCon
        
          set FSO = CreateObject("Scripting.FileSystemObject")
          
          ' функция обработки файлов в системе
          call create_or_delete_dbf(objADOQueryLoc, FSO, ecr_TEServer_QuantityPLU)
        
          ' linecounter -  для подсчета позиций
          linecounter = 0
        
          gdcDocLine.ParamByName("companykey").AsInteger = ibLogin.CompanyKey
          gdcDocLine.Open
          
          dim prCount : prCount = 0
          gdcDocLine.First
          While not gdcDocLine.EOF
            prCount = prCount + 1
            gdcDocLine.next
          wend
          prForm.Max = prCount
          prForm.Note = "Идет передача данных. Ожидайте..."
          prForm.Show
          
          Except ProgressFormRem(prForm)
        
          DBFnumb = 0
          gdcDocLine.First
          while not gdcDocLine.EOF
            select case linecounter
           '   case 2500
        '        DBFnumb = 1
        '      case 5000
        '        DBFnumb = 2
              case 7500
                DBFnumb = 1
           '   case 10000
        '        DBFnumb = 4
        '      case 12500
        '        DBFnumb = 5
              case 15000
                DBFnumb = 2
         '     case 17500
        '        DBFnumb = 7
        '      case 20000
        '        DBFnumb = 8
              case 22500
                DBFnumb = 3
            '  case 25000
        '        DBFnumb = 10
            end select
            set DeptField = gdcDocLine.FieldByName("CONTACTKEY")
        
        ''''''''''''''''''''''''''''''''
        ''''''''''''''''''''''''''''''''
        'if ecr_DeptList.CodeByCost then
        '      plucode = gdcDocLine.FieldByName("USR$SDR_ECRCODE1").AsString + _
        '        gdcDocLine.FieldByName("USR$SDR_ECRCODE").AsString
        '    else
        '      plucode = gdcDocLine.FieldByName("BARCODE").AsString
        'end if
          IF depart(0)>-1 THEN
            ' если по подразделению
            IF ecr_DeptList.CodeByCost THEN
              plucode = gdcDocLine.FieldByName("USR$SDR_ECRCODE1").AsString + _
                gdcDocLine.FieldByName("USR$SDR_ECRCODE").AsString
            ELSE
                plucode = gdcDocLine.FieldByName("BARCODE").AsString
            END IF
          ELSE
            ' для передачи по ШК
            IF gdcDocLine.FieldByName("BARCODE").AsString = "" THEN
              plucode = gdcDocLine.FieldByName("USR$SDR_ECRCODE1").AsString + _
                gdcDocLine.FieldByName("USR$SDR_ECRCODE").AsString
            ELSE
              plucode = gdcDocLine.FieldByName("BARCODE").AsString
            END IF
          END IF
            
        
        
            ' товары м.б. на разных подразделениях
            DeptNp = ecr_DeptList.GetNpByID(DeptField.AsInteger)
            ' номер секции
            Section = ""
            SectionID = ecr_DeptList.GetSectionByID(DeptField.AsInteger)
            if SectionID > -1 then
              Section = CStr(SectionID)
            end if
        
            dim Price
            PRICE = gdcDocLine.FieldByName("USR$INV_COSTRETAILNCU").AsVariant
        
          call insert_into_FFN_1(objADOQueryLoc,ecr_TEServer_Ref_Filename, ecr_TEServer_QuantityPLU, Section,plucode, gdcDocLine.FieldByName("NAMEGOOD").AsString,PRICE,DeptNp, gdcDocLine.FieldByName("REMAINS").AsCurrency)
            linecounter = linecounter + 1
        '    prForm.Note = "Товар: " & gdcDocLine.FieldByName("NAMEGOOD").AsString
            PrForm.SubNote = "Передано: " & CSTR(linecounter) & " из " & CSTR(prCount)
            prForm.Position = prForm.Position + 1
            Application.ProcessMessages
            except ProgressFormRem(prForm)
            gdcDocLine.Next
          wend
        '  gdcDocLine.First
        
          PrForm.Note = "Идет сохранение...Ожидайте..."
          PrForm.SubNote = "............."
          Application.ProcessMessages
          
          ' количество - перезаписывается!
          dim plname, idN , Fname
          plname = ""
          ' очистим commond.dbf
          IF FSO.FileExists(replace(ecr_TEServer_FullCommandFileName,"'","")) Then
            ' objADOQuery.Close
             objADOQuery.CommandText = "DELETE FROM command "
             objADOQuery.Execute
          end if
        
          ' внесем в него данные для файлов
        
          for j=1 to ecr_TEServer_QuantityPLU
            idN = ecr_TEServer_QuantityPLU - 1
            if j=1 then
             plname = "'" & FFName(0) & "'"
            else
             plname = "'" & FFName(0) & CSTR(j) & "'"
             idN =  idN + j
            end if
          Fname = plname
          
          '''''''''''''''''''''''''''''''''''''''''''''''''''''''''
          ' вот тут скопируем файлы для лога
          ' для работы нужно указать путь к папке для хранения лога и в константах не забыть указать путь врем
          ' call copy_dbf_temp(ecr_TEServer_path_Log, Fname, FSO)
        
          InsertSQL = "INSERT INTO command " & _
            "(ROWID," & _
            "SERVERID," & _
            "COMMANDID," & _
            "FILENAME," & _
            "FLAG) "  & _
            "VALUES(" & _
            idN & ", " & _
            ecr_TEServer_ServerID & ", " & _
            ecr_TEServer_ocSetPLUr & ", " & _
            plname & "," & _
            "0) "
          objADOQuery.CommandText = InsertSQL
          objADOQuery.Execute
          next
        
          ceDescr = ""
          ecr_CriticalError = ecr_TEServer_Waiting_ADO(ObjCon, ceDescr)
        
          prForm.Close
          TmE = Time
          if ecr_CriticalError = ecr_TEServer_ceOK then
            call MsgBox("Данные успешно переданы." & vbCrLf & "На выполнение затрачено: " & Tm_work(TmS, TmE) & vbCrLf, mb_OK or mb_IconInformation or mb_TaskModal, "Внимание")
          else
            call MsgBox("При передаче данных возникла ошибка! - " + ceDescr, mb_OK or mb_IconExclamation or mb_TaskModal, "Внимание")
          end if
        
        end sub
        
        function Tm_work(TmS, TmE)
         Tm_work = ""
         dim TS, TmSum, Ms, Ss
         TmSum = 0
         Ss = DateDiff("s",TmS,TmE)
          if Ss > 60 Then
            T  = Ss/60
            Ms = Int(T)
            Ss = Int(Ss-Ms*60)
          else
            Ms = 0
          end if
          dim i
          select case Ms
           case 0  i = ""
           case 1  i = CSTR(Ms) + " минута, "
           case 2,3,4  i = CSTR(Ms) + " минуты, "
           case else i = CSTR(Ms) + " минут, "
          end select
        
         Tm_work =  i + CSTR(Ss) + " секунд(ы): "
        end function
        
        ' процедура обработки dbf в системе
        ' counter - количество необходимых дбф файлов
        sub create_or_delete_dbf(objADOQuery, FSO, counter)
         dim j, FN, SFN, SF_N
         SFN = Split(ecr_TEServer_Ref_Filename,".")
         SF_N =SFN(0)
         for j = 1 to counter
           FN = SF_N
           if j > 1 Then
              FN = SF_N + CSTR(j)
           end if
        
           if FSO.FileExists(ecr_TEServer_workpath_local + FN + ".dbf") then
             'найдена в системе - удалим
             call del_dbf(objADOQuery, FN)
           end if
           
          ' создадим dbf
          call cre_dbf(objADOQuery, FN)
         next
        end sub
        
        ''''''''''''''''''''''''''''''
        ' создаем файл dbf
        sub cre_dbf(objADOQuery, FF_N)
          objADOQuery.CommandText = _
          "CREATE TABLE " + _
          FF_N + _
          " (SECTIONID CHAR(4), " + _
          "  PLU CHAR(18), " + _
          "  PLUNAME CHAR(60), " + _
          "  PRICE NUMERIC(13, 2), " + _
          "  DEPARTMENT NUMERIC(2, 0), " + _
          "  DISCOUNT NUMERIC(6, 2), " + _
          "  Q NUMERIC(13, 3), " + _
          "  SQ NUMERIC(5, 3), " + _
          "  DQ NUMERIC(6, 3), " + _
          "  LOCK INTEGER) "
          on error resume next
          objADOQuery.Execute
          on error goto 0
        end sub
        
        ''''''''''''''''''''''''''''''
        ' удаляем файл dbf
        sub del_dbf(objADOQuery, Fname)
          objADOQuery.CommandText = "DROP TABLE " + Fname + ".dbf'"
          on error resume next
          objADOQuery.Execute
          on error goto 0
        end sub
        
        ''''''''''''''''''''''''''''''
        ' заполняем dbf товарами
        sub insert_into_FFN_1(objADOQuery,FullFileName,DBFnumb,SECTIONID,PLU,PLUNAME,PRICE,DEPT,QUANT)
         DIM FullName
         FFName = Split(FullFileName,".")
         IF DBFnumb > 1 Then
          FullName =FFName(0) & CSTR(DBFnumb)
         else
          FullName =FFName(0)
         end if
        
          objADOQuery.Cancel
          InsertSQL = "INSERT INTO " & FullName & _
          "(SECTIONID," & _
          "PLU," & _
          "PLUNAME," & _
          "PRICE," & _
          "DEPARTMENT," & _
          "Q) " & _
          " VALUES(" & _
              "'" & SECTIONID & "'," & _
              "'" & PLU & "'," & _
              "'" & replace(PLUNAME,"'","") & "'," & _
              Replace(PRICE,",",".") & "," &  _
              DEPT & "," & _
              Replace(QUANT,",",".") & ") "
          objADOQuery.CommandText = InsertSQL
          objADOQuery.Execute
        end sub
        
        ''''''''''''''''''''''''''''''
        ' остатки
        function get_remains_SQL(depart)
          get_remains_SQL = _
            "SELECT  " & _
            "  MIN ( M.CARDKEY ) AS ID,  " & _
            "  G.ID AS GOODKEY,  " & _
            "  G.NAME AS NAMEGOOD,  " & _
            "  G.ALIAS AS GOODALIAS,  " & _
            "  SUM ( M.BALANCE ) AS REMAINS,  " & _
            "  CON.ID AS CONTACTKEY,  " & _
            "  C.USR$SDR_ECRCODE,  " & _
            "  C.USR$INV_COSTRETAILNCU,  " & _
            "  G.USR$SDR_ECRCODE,  " & _
            "  G.BARCODE  " & _
            "  " & _
            "FROM  " & _
            "  INV_CARD C " & _
            "    JOIN  " & _
            "      GD_GOOD G " & _
            "    ON  " & _
            "      ( G.ID  =  C.GOODKEY )  " & _
            "    JOIN  " & _
            "      INV_BALANCE M " & _
            "    ON  " & _
            "      C.ID  =  M.CARDKEY " & _
            "         AND  " & _
            "      M.BALANCE  >  0 " & _
            "    JOIN  " & _
            "      GD_CONTACT COMPANY " & _
            "    ON  " & _
            "      COMPANY.ID = C.COMPANYKEY  " & _
            "    JOIN  " & _
            "      GD_CONTACT CON " & _
            "    ON  " & _
            "      M.CONTACTKEY  =  CON.ID " & _
            "         AND  " & _
            "      CON.LB  >=  COMPANY.LB " & _
            "         AND  " & _
            "      CON.RB  <=  COMPANY.RB " & _
            " " & _
            "WHERE  " & _
            "   C.COMPANYKEY   =  :companykey " & _
            "     AND  " & _
            "  M.BALANCE  >  0 "
            IF depart(0)>-1 THEN
              get_remains_SQL = get_remains_SQL & _
              " and CON.id = " & depart(0)
            ELSE
             get_remains_SQL = get_remains_SQL & _
              " and CON.id in (147042927, 147042928, 147042930, 147042929) and (not G.BARCODE is NULL) "
            END IF
            get_remains_SQL = get_remains_SQL & _
            " GROUP BY " & _
            "  G.ID,  " & _
            "  G.NAME,  " & _
            "  G.ALIAS,  " & _
            "  CON.ID,  " & _
            "  C.USR$SDR_ECRCODE,  " & _
            "  C.USR$INV_COSTRETAILNCU,  " & _
            "  G.USR$SDR_ECRCODE,  " & _
            "  G.BARCODE " & _
            "HAVING  " & _
            "  SUM ( M.BALANCE )  >  0 " & _
            " "
        end function
        
        ' делаем копию файла для отлова ошибок на кассе
        sub copy_dbf_temp(logpath, file_name, FSO)
          on error resume next
          dim log_file, log_folder , OwerWriteExisting
          if not FSO.FolderExists(logpath) then
            Call Application.MessageBox("Отсутствует папка для хранения лог-файлов", "Внимание!", vbSystemModal+vbInformation+vbOkOnly)
            exit sub
          end if
          logpath = "d:\Gedemin\DBF\"
          file_name = replace(file_name,"'","")
          OwerWriteExisting = False
          ' нужно добавить к имени файла дату и время для упрощения поиска
          ' формат имя_файла_дата_время : plu_ref2_02102017_101212.dbf
          ' имя лог-файла
          log_file = file_name + "_" + Replace(Replace(Replace(CDATE(now),".","")," ", "_"),":","") + ".dbf"
          ' копируем
          FSO.CopyFile ecr_TEServer_workpath_local + file_name + ".dbf", logpath + log_file , OwerWriteExisting
        
         ' if not FSO.FolderExists(ecr_TEServer_commandpath) then
          '  Call Application.MessageBox("Отсутствует сетевая папка", "Внимание!", vbSystemModal+vbInformation+vbOkOnly)
         '   exit sub
         ' else
           FSO.CopyFile ecr_TEServer_workpath_local + file_name + ".dbf", ecr_TEServer_commandpath + file_name + ".dbf" , True
        '  end if
          on error goto 0
        end sub
        
        ''''''''''''''''''''''''''''''
        ' ProgressBar
        sub ProgressFormRem(prForm)
          prForm.Close
          set prForm = Nothing
        end sub
        
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147854992_375143752 Twg_ProgressForm"
          - 
            ADDFUNCTIONKEY: "215165918_639165248 ecr_TEServer_Waiting_ADO"
          - 
            ADDFUNCTIONKEY: "148919176_537677461 gs_DnmnToDivide"
          - 
            ADDFUNCTIONKEY: "147040356_260108671 ecr_DeptList"
          - 
            ADDFUNCTIONKEY: "147012321_13359259 ecr_ZServer_SetParams"
          - 
            ADDFUNCTIONKEY: "147020216_281066798 ecr_TEServer_Waiting"
          - 
            ADDFUNCTIONKEY: "147006692_122479781 ecr_ZServer_CreateTable"