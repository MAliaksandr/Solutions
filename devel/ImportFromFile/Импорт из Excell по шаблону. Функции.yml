%YAML 1.1
--- 
StructureVersion: "1.0"
Properties: 
  RUID: 154577947_1631104572
  Name: "Импорт из Excell по шаблону. Функции"
  Caption: "Импорт из Excell по шаблону. Функции"
  Version: "1.0.0.7"
  Optional: False
  Internal: True
  MD5: 7A0877E9DAADB7F992C0C29FC7EABED2
Objects: 
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 154566998_1631104572
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      NAME: "ImFF_TmplSetParams"
      COMMENT: ~
      EVENT: ~
      FUNCTIONTYPE: ~
      GROUPNAME: ~
      INHERITEDRULE: 0
      LANGUAGE: "VBScript"
      LOCALNAME: ~
      MODIFYDATE: ~
      MODULE: "CONST"
      MODULECODE: "1010001_17 APPLICATION"
      OBJECTNAME: "APPLICATION"
      OWNERNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      USEDEBUGINFO: 0
      EDITIONDATE: 2022-03-09T13:19:50+03:00
      DISPLAYSCRIPT: ~
      ENTEREDPARAMS: ~
      SCRIPT: | 
        'Переменные для импорта из Excell на основании шаблонов
        public pGNAME
        public pVNAME      'ед.изм
        public pStartLine  'номер строки, с которой начинаем работу
        
        public pCOSTBYNCU
        public pVATPERC     ' ставка НДС
        public pDESCR       ' Описание
        public pBARCODE     ' ШК
        
        public pALIAS_end   ' определяет расположение ALIAS в строке
        public pBARCODE_end ' определяет расположение BARCODE в строке
        
        public pALIAS       '
        public pSELLCOST
        
        public pCountry    ' страна происхождения
        public pDefCountry ' страна происхождения по умолчанию
        
        public pAndRecL    ' номер колонки, по которой будет проверяться конец файла
        public pQfreeLine  ' количество последовательно идущих пустых строк
        public pQuant      ' количество ТМЦ в позиции документа
        
        public pDocDate    ' дата документа
        public pDocNumb    ' номер документа
        public pPath       ' рабочая директория
        public pDept       ' подразделение
        public pClient     ' клиент
        
        public pGroupKey   ' товарная группа, кот. будет использоваться по умолчанию при вставке нового товара
        
        
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 154566984_1631104572
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      NAME: "Imff_setParams"
      COMMENT: ~
      EVENT: ~
      FUNCTIONTYPE: ~
      GROUPNAME: ~
      INHERITEDRULE: 0
      LANGUAGE: "VBScript"
      LOCALNAME: ~
      MODIFYDATE: ~
      MODULE: "UNKNOWN"
      MODULECODE: "1010001_17 APPLICATION"
      OBJECTNAME: "APPLICATION"
      OWNERNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      USEDEBUGINFO: 0
      EDITIONDATE: 2022-03-09T13:24:22+03:00
      DISPLAYSCRIPT: | 
        IMFF_SETPARAMS
        
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QFAAAAVEVNUEwFAAAAVEVNUEwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAARk5TVEZM
        UFI=
      SCRIPT: | 
        Function Imff_setParams(BYVal templ)
          'функция определяет массив глобальных переменных из заданного шаблона
          'примерно так:
          'наим.ТМЦ/ШК/артикул/цена покуп/%НДС/роз.цена/описание/
          '-------- так же нужно учесть определяется ли НОМЕР ЯЧЕЙКИ или НАЗВАНИЕ -> возвращаться будет число либо наимнование
          '-------------------------------------------------------
          '-------------------------------------------------------
          ' !!!!!!!! при добавлении новых параметров, их необходимо объявить в глоб переменных ImportTmplSetParams !!!!!!!!
          '-------------------------------------------------------
          '-------------------------------------------------------
        
          set Creator = New TCreator
          set gdcTemplParam = Creator.GetObject(nil, "TgdcAttrUserDefined", "")
          gdcTemplParam.SubType = "USR$IMPORTTEMPLATE"
          gdcTemplParam.ExtraConditions.Add("z.ID = :ID")
          gdcTemplParam.ParamByName("ID").AsInteger = templ(0)
          gdcTemplParam.Open
          gdcTemplParam.Last
        
          IF gdcTemplParam.RecordCount > 0 then
            'наименование ТМЦ
            pGNAME = gdcTemplParam.FieldByName("USR$GOODNAME").AsInteger
            'ед.изм
            pVNAME = gdcTemplParam.FieldByName("USR$VALUENAME").AsInteger
            'розн.цена
            pSELLCOST = gdcTemplParam.FieldByName("USR$SELLCOST").AsInteger
            'ШК
            pBARCODE = gdcTemplParam.FieldByName("USR$BARCODE").AsInteger
            '
            pBARCODE_end = gdcTemplParam.FieldByName("USR$BARCODE_END").AsInteger
            'код товара
            pALIAS = gdcTemplParam.FieldByName("USR$ALIAS").AsInteger
            
            pALIAS_end = gdcTemplParam.FieldByName("USR$ALIAS_END").AsInteger
            'покупная цена
            pCOSTBYNCU = gdcTemplParam.FieldByName("USR$COSTBYNCU").AsInteger
            'ставка НДС
            pVATPERC = gdcTemplParam.FieldByName("USR$VATPERC").AsInteger
            'описание ТМЦ
            pDESCR = gdcTemplParam.FieldByName("USR$DESCRIPTION").AsInteger
            
            'номер строки, с которой начинаем работу
            pStartLine = gdcTemplParam.FieldByName("USR$STARTLINE").AsInteger
            ' номер колонки, по которой будет проверяться конец файла
            pAndRecL = gdcTemplParam.FieldByName("USR$STARTLINE").AsInteger
            ' количество последовательно идущих пустых строк
            pQfreeLine = gdcTemplParam.FieldByName("USR$QFREELINE").AsInteger
            ' количество ТМЦ в позиции документа
            pQuant = gdcTemplParam.FieldByName("USR$QUANTITY").AsInteger
            ' товарная группа, кот. будет использоваться по умолчанию при вставке нового товара
            pGroupKey = gdcTemplParam.FieldByName("USR$GOODGROUP").AsInteger
            
            'краіна паходжання
            pCountry = gdcTemplParam.FieldByName("USR$COUNTRY").AsInteger
            pDefCountry = gdcTemplParam.FieldByName("USR$DEFCOUNTRY").AsInteger
            
            pDocDate = gdcTemplParam.FieldByName("USR$DOCDATE").AsInteger      ' дата документа
            pDocNumb = gdcTemplParam.FieldByName("USR$DOCNUMBER").AsInteger    ' номер документа
            pPath = gdcTemplParam.FieldByName("USR$PATH").AsString             ' рабочая директория
            pDept = gdcTemplParam.FieldByName("USR$DEPARTMENT").AsInteger      ' подразделение
            pClient = gdcTemplParam.FieldByName("USR$CONTACT").AsInteger       ' клиент
            
            if pQuant = 0 Then
              call Application.MessageBox("В шаблоне не задано поле для 'количества'" & vbCrLf & _
              "Возможны ошибки при импорте!", "Внимание", vbOkOnly + vbCritical + vbSystemModal)
            end if
          else
            call Application.MessageBox("Не указан шаблон", "Внимание", vbOkOnly + vbInformation + vbSystemModal)
          end if
          
          gdcTemplParam.Close
        End Function
        
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 154577838_1631104572
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      NAME: "Imff_findgood"
      COMMENT: ~
      EVENT: ~
      FUNCTIONTYPE: ~
      GROUPNAME: ~
      INHERITEDRULE: 0
      LANGUAGE: "VBScript"
      LOCALNAME: ~
      MODIFYDATE: ~
      MODULE: "UNKNOWN"
      MODULECODE: "1010001_17 APPLICATION"
      OBJECTNAME: "APPLICATION"
      OWNERNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      USEDEBUGINFO: 0
      EDITIONDATE: 2022-03-09T14:21:22+03:00
      DISPLAYSCRIPT: | 
        IMFF_FINDGOOD
        FINDBARCODE
        
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QFAAAASUJTUUwFAAAASUJTUUwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAARk5TVFBS
        U1QCAAAAU0gCAAAAU0gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAARk5TVFBSU1QFAAAAVEVNUEwF
        AAAAVEVNUEwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAARk5TVEZMUFI=
      SCRIPT: | 
        'ф-я шукае ТМЦ у БД па розным крытэрыям.
        'паслядоўнасть пошуку будзе абазначана пазней
        'яна(ф-я) павінна венуць GOODKEY альбо знойдзенага альбо зноў устаўленнага
        'правяраем шаблён на ненулявые значенні
        Function Imff_findgood(ibSQL, Sh, templ)
          Imff_findgood = -1
        
          if pAlias<>0 and not isNull(pAlias) Then
            ibsql.Close
            ibsql.SQL.Text = _
            "SELECT " & _
            "  ID " & _
            "FROM GD_GOOD " & _
            "WHERE ALIAS =:ALIAS "
            ibsql.ParamByNAme("ALIAS").asString = Sh.Cells(pStartLine, pAlias).Value
            ibsql.ExecQuery
        
            if not ibsql.EOF Then
              Imff_findgood = ibsql.FieldByName("ID").asInteger
              exit function
            end if
          end if
        
          IF pBarCode<>0 and not isNull(pBarCode) THEN
            ByBarCode = Sh.Cells(pStartLine, pBarCode).Value
        
            if templ(0)= gdcBaseManager.GetIDByRUIDString("235081136_1833050115") Then
              ByBarCode = Sh.Cells(pStartLine+2, pBarCode).Value
              dim arr
              arr = Split(ByBarCode)
              ByBarCode =arr(UBound(arr))
            end if
        
            If Len(ByBarCode) = 12 Then
              ibsql.SQL.Text = _
              "select g.id from gd_good g " & _
              " /*LEFT JOIN CALC_EAN13(:cod) ean13 ON 1=1*/ " & _
              "WHERE Left(g.BARCODE,12) = :cod " & _
              "   /*OR EAN13.BARCODE_EAN13 = g.BARCODE*/ "
              ibsql.Close
              ibsql.ParamByName("cod").AsString = ByBarCode
              ibsql.ExecQuery
        
              if not ibsql.eof then
               Imff_findgood = ibsql.FieldByName("ID").AsInteger
               Exit Function
              End If
            End If
        
          
            If Len(ByBarCode) = 7 Then
             ibsql.SQL.Text = _
             "select g.id from gd_good g " & _
             "LEFT JOIN CALC_EAN8(:cod) ean13 ON 1=1 " & _
             "WHERE Left(g.BARCODE,7) = :cod " & _
             "   OR EAN13.BARCODE_EAN8 = g.BARCODE "
             ibsql.Close
             ibsql.ParamByName("cod").AsString = ByBarCode
             ibsql.ExecQuery
             if not ibsql.eof then
               Imff_findgood = ibsql.FieldByName("ID").AsInteger
               Exit Function
             end If
            END IF
            
             ibsql.SQL.Text = _
             "select g.id from gd_good g " & _
             "WHERE g.BARCODE = :cod "
             ibsql.Close
             ibsql.ParamByName("cod").AsString = ByBarCode
             ibsql.ExecQuery
             if not ibsql.eof then
               Imff_findgood = ibsql.FieldByName("ID").AsInteger
               Exit Function
             end If
          END IF
        
             ibsql.SQL.Text = _
             "select g.id from gd_good g " & _
             "WHERE g.name = :gname "
             ibsql.Close
             ibsql.ParamByName("gname").AsString = Left(Sh.Cells(pStartLine, pGNAME).Value,60)
             ibsql.ExecQuery
        
             if not ibsql.eof then
               Imff_findgood = ibsql.FieldByName("ID").AsInteger
             end If
        End Function
        
        function findBarCode(vl)
          dim arr
          arr = Split(vl)
          ' проверим наличие ШК
          for i = LBound(arr) to UBound(arr)
        
          next
        
        end function
        
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 154479221_1631104572
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      NAME: "Imff_Excell"
      COMMENT: ~
      EVENT: ~
      FUNCTIONTYPE: ~
      GROUPNAME: ~
      INHERITEDRULE: 0
      LANGUAGE: "VBScript"
      LOCALNAME: ~
      MODIFYDATE: ~
      MODULE: "UNKNOWN"
      MODULECODE: "1010001_17 APPLICATION"
      OBJECTNAME: "APPLICATION"
      OWNERNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      USEDEBUGINFO: 0
      EDITIONDATE: 2022-03-09T15:04:15+03:00
      DISPLAYSCRIPT: | 
        IMFF_EXCELL
        IMFF_EXCELL_ROLLBACK
        ANDRECORDS
        CORRECTLINE
        CORRECTVALUE
        RETTYPEVALUE
        ADDLINE2
        LEGALTYPEVALUE
        FINDCOUNTRY
        FINDGOOD
        ARR_GOODINFO
        
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QJAAAAT1dORVJGT1JNCQAAAE9XTkVSRk9STQAAAAAAAAAAAAAAAAsAAAAAAAAAAAAA
        AABGTlNURkxQUg==
      SCRIPT: | 
        '#include IMFF_FINDGOOD
        '#include IMFF_SETPARAMS
        'Option Explicit
        Function Imff_Excell(OwnerForm)
          dim ParamList, ParamWindow, ParamIndex, depart, result , tempParam, templ
           ' Создание диалога
          set ParamWindow = System.GetNewParamWindow(0)
           ' Присвоим список параметров отдельной переменной
          set ParamList = ParamWindow.ParamList
           ' Добавление параметра через объект-диалог
        
          call ParamWindow.AddLinkParam("Шаблон", "prmLinkElement", "USR$IMPORTTEMPLATE", "id", "usr$NAME", "COALESCE(DISABLED,0)=0" , "", "Выбор типа лимита")
          ParamList.Params(0).Required = True
        
           ' Отображение диалога и получение результата
          result = ParamWindow.ExecuteWithParamList(ParamList)
          if IsEmpty(result) then
             exit Function
          end if
          
          templ = result(0)
          
          ' тут мы определяем индексы(ячейки) соответствующие нужным данным
          Imff_setParams(templ)
        
          dim Creator, OpenDialog, FileName
          set Creator = new TCreator
          set OpenDialog = Creator.GetObject(nil, "TOpenDialog", "")
          Dim gdcObject, gdcDetailObject, DS
          set gdcObject = OwnerForm.gdcObject
          set gdcDetailObject = OwnerForm.Documentline
          
          IF (not isNull(pDept) and pDept<>0)  and (not isNull(pClient) and pClient<>0) then
            if (gdcObject.FieldByname("usr$deptkey").asInteger <> pDept) or (gdcObject.FieldByname("usr$contactkey").asInteger <> pClient) then
              if Application.MessageBox("Один или несколько параметров в шапке документа не соответсвует параметрам шаблона. Подставить данные из шаблона?", "Внимание", vbYesNo+vbSystemModal+vbExclamation) = vbYes then
                if (gdcObject.State<>dsEdit) or (gdcObject.State<>dsInsert) then
                  gdcObject.Edit
                  gdcObject.FieldByname("usr$deptkey").asInteger = pDept
                  gdcObject.FieldByname("usr$contactkey").asInteger = pClient
                  gdcObject.Post
                end if
              end if
            end if
          end if
          
          if ((gdcObject.FieldByname("usr$deptkey").isNull) or (gdcObject.FieldByname("usr$contactkey").isNull)) then
            call Application.MessageBox("Не заполнены обязательные поля в шапке документа", "Внимание", vbOkOnly+vbSystemModal+vbCritical)
            exit function
          end if
        
          OpenDialog.Filter = "*.xls|*.xls"
          OpenDialog.DefaultExt = "xls"
        
          if OpenDialog.Execute then
            FileName = OpenDialog.FileName
          else
            Exit function
          end if
        
          Dim Exc, Sh, Sh1
          Set Exc = CreateObject("Excel.Application")
          if not Assigned(Exc) then Exit function
          except Imff_Excell_Rollback(Exc)
        
          set Creator = New TCreator
          call Exc.Workbooks.Open(FileName)
        
          dim i, c  ,goodname,quantity,price
          c = 0
          ' проверка на непустые лісты в кніге
          for  i =1 to  Exc.Worksheets.count
            set Sh1 = Exc.Worksheets(i)
            '' проверка на ПУСТОЙ лист
            ''if ((Sh1.Cells(1, 1).Value <> "") and (Sh1.Cells(1, 2).Value = "")) then
              c = i
            ''  exit for
            '' end if
          next
          if (c <> 0 ) then
            set  Sh = Exc.Worksheets(c)
        
            dim ibSQL,  gdcGood
            set ibSQL = Creator.GetObject(nil, "TIBSQL", "")
            ibSQL.Transaction = gdcObject.Transaction
            
            set gdcGood = Creator.GetObject(nil, "TgdcGood", "")
            DIM description
            description = ""
            r = pStartLine
           WHILE NOT andRecords(Sh, pStartLine)
             IF CorrectLine(Sh, pStartLine) THEN
               call addLine2(ibSQL, Creator, gdcObject.Transaction, gdcDetailobject, Sh, templ)
             END IF
             pStartLine = pStartLine + 1
           WEND
          end if
        
          
          if Assigned(Exc) then
            Exc.Workbooks.Close
            set Exc = nothing
          end if
          
          gdcObject.CloseOpen
          
        End Function
        
        ' откат при ошибке
        Sub Imff_Excell_Rollback(Exc)
          if Assigned(Exc) then Exc.Workbooks.Close
          set Exc = nothing
        End sub
        
          ' конец файла по третьей колонке?
          ' нужно учесть, с какой строки по шаблону начинаются данные
          ' pQfreeLine колічество пустых строк
        function andRecords(Sh, r)
          andRecords = false
             res = 0
             For i = r to pQfreeLine + r
               if Sh.Cells(i, pAndRecL).Value = "" Then
                 res = res + 1
               end if
             next
             
             if res = pQfreeLine and r = pAndRecL then
                call Application.MessageBox("Неожиданный конец файла. " & vbCrLf & "Выполнение будет остановлено! " & vbCrLf & _
                   "Текущее значение параметра проверки столбца: " & CSTR(pAndRecL) & vbCrLf & _
                   "Измените параметры в шаблоне и повторите попытку!", "Внимание", vbOkOnly + vbExclamation + vbSystemModal)
                   andRecords = true
             elseif res = pQfreeLine + 1  and r > pAndRecL Then
                call Application.MessageBox("Достигнут конец файла с данными. " & vbCrLf & _
                   "Операция успешно завершена", "Внимание", vbOkOnly + vbExclamation + vbSystemModal)
                   andRecords = true
             end if
          
             ' if Sh.Cells(r, pAndRecL).Value = "" and _
        '         Sh.Cells(r+1, pAndRecL).Value  = "" and _
        '         Sh.Cells(r+2, pAndRecL).Value = "" Then
        '         call Application.MessageBox("Неожиданный конец файла. " & vbCrLf & "Выполнение будет остановлено! " & vbCrLf & _
        '         "Текущее значение параметра проверки столбца: " & CSTR(pAndRecL) & vbCrLf & _
        '         "Измените параметры в шаблоне и повторите попытку!", "Внимание", vbOkOnly + vbExclamation + vbSystemModal)
        '       andRecords = true
        '      end if
        end function
        
        ' здесь же проверим корректность данных, на случай если в файле лишь бы что идет
        function CorrectLine(Sh, r)
           CorrectLine = true
        
             ' покупная цена не строка и не 0 (в параметрах шаблона указана)
             if not correctvalue(Sh.Cells(r, pCostByNCU).Value) then CorrectLine = False
             
             ' количество не строка и не 0 (в параметрах шаблона указана)
             if not correctvalue(Sh.Cells(r, pQuant).Value) then CorrectLine = False
             
             ' наименование ТМЦ не менее 3 символов
             IF Sh.Cells(r, pGNAME).Value <> "" and LEN(Sh.Cells(r, pGNAME).Value)<=3 Then CorrectLine = false
             
        end function
        
        
        function correctvalue(v)
          correctvalue = True
          on error resume next
          v = CCUR(Replace(v,".",","))
          if err.number <> 0 then
            correctvalue = false
            on error goto 0
          end if
        end function
        
        'vtype - тое, што патрэна вяртяць
        '1- лічба, 2- літары
        function RetTypeValue(v, vtype)
          RetTypeValue = v
          select case vtype
            case 1
              if TypeName(v)= "String" then
                v = Trim(v)
                v = Replace(v,";","")
                v = Replace(v,"/","")
                v = CCUR(Replace(v,".",","))
              end if
            case 2
              v = CSTR(v)
            case else
          end select
          RetTypeValue = v
        end function
        
        
        ' функция вставки позиций
        sub addLine2(ibSQL, Creator, tr, gdcDetailobject, Sh, templ)
        
          goodname = Sh.Cells(pStartLine, pGNAME).Value
          quantity = cstr(Sh.Cells(pStartLine, 2).Value)
          price =  Replace(Sh.Cells(pStartLine, pCostByNCU).Value, "'", "")
        
          dim gdcGood
          set gdcGood = Creator.GetObject(nil, "TgdcGood", "")
          gdcGood.Transaction = Tr
          gdcGood.Open
          
        
          dim BookMark , goodkey, garr
          redim garr(2)
          garr(0) = goodname
          garr(1) =quantity
          garr(2) = price
        
         ' goodkey = findGood(Creator, tr, goodname)
          
          goodkey = Imff_findgood(ibSQL, Sh, templ)
          
          Dim stAlias: stAlias =""
          Dim stBarcode: stBarcode =""
          Dim stDescr: stDescr = ""
        
          ibSQL.Close
          ibSQL.SQL.Text = _
            "SELECT FIRST(1) " & _
            " ID " & _
            "FROM GD_VALUE V " & _
            "WHERE UPPER(V.NAME) LIKE UPPER(:VNAME) || '%' "
          
          if goodkey<0 then
            if pAlias<>0 and not isNull(pAlias) Then
              stAlias = Trim(Sh.Cells(pStartLine, pAlias).Value)
            end if
            if pBarcode<>0 and not isNull(pBarcode) Then
              stBarcode = Trim(Sh.Cells(pStartLine, pBarcode).Value)
              if templ(0)= gdcBaseManager.GetIDByRUIDString("235081136_1833050115") Then
                stBarcode = Sh.Cells(pStartLine+2, pBarCode).Value
                dim arr
                arr = Split(stBarcode)
                stBarcode =arr(UBound(arr))
              end if
        
            end if
            if pDescr<>0 and not isNull(pDescr) Then
              stDescr = Trim(Sh.Cells(pStartLine, pDescr).Value)
            end if
        
           ibSQL.Close
           ibSQL.ParamBYName("VNAME").asString  = Sh.Cells(pStartLine, pVNAME).Value
           ibSQL.ExecQuery
           if not ibSQL.EOF Then
             valuekey = ibSQL.FieldBYName("ID").asInteger
           end if
          
           gdcGood.Insert
           gdcGood.FieldByName("alias").AsString = stAlias
           gdcGood.FieldByName("name").AsString = Trim(Sh.Cells(pStartLine, pGNAME).Value)
           gdcGood.FieldByName("BARCODE").AsString = stBarcode
           gdcGood.FieldByName("groupkey").AsString =  pGroupKey  ''''''''''
           gdcGood.FieldByName("valuekey").AsString = valuekey           '''''''''''
           gdcGood.FieldByName("description").AsString = stDescr
           gdcGood.Post
           gdcDetailObject.Transaction.CommitRetaining
           goodkey = gdcGood.Id
         '  tf.WriteLine("Добавлен товар: " & Trim(Exc.ActiveSheet.Cells(i,4).Value) & "")
         'else
        '   goodkey = ibsql.FieldByName("ID").AsInteger
         end if
          
          gdcDetailObject.DisableControls
          BookMark = gdcDetailObject.GetBookMark
          gdcDetailobject.Append
          gdcDetailObject.FieldbyName("goodkey").AsInteger = goodkey
          gdcDetailObject.FieldbyName("quantity").asCurrency = Sh.Cells(pStartLine, pQuant).Value
        
          gdcDetailObject.FieldbyName("TO_USR$INV_COSTPROVIDER").asCurrency  = RetTypeValue(Sh.Cells(pStartLine, pCostByNCU).Value, 1)
          gdcDetailObject.FieldbyName("TO_USR$INV_COSTBUYNCU").asCurrency  = RetTypeValue(Sh.Cells(pStartLine, pCostByNCU).Value, 1)
          gdcDetailObject.FieldbyName("TO_USR$INV_ADDNDS").asCurrency  = CINT(Left(Sh.Cells(pStartLine, pVatPerc).Value,2))
        
          ' краіна паходжання
          if not isNull(pCountry) and (pCountry<>0) then
            gdcDetailObject.FieldbyName("TO_USR$INV_ORIGINCOUNTRYKEY").asVariant = findCountry(ibSQL, Sh)
          else
            if not isNull(pDefCountry) then
              gdcDetailObject.FieldbyName("TO_USR$INV_ORIGINCOUNTRYKEY").asVariant = pDefCountry
            end if
          end if
          
          'если организация НЕ ПЛАТЕЛЬЩИК НДС
          if not InvOptions.NDSDodger Then
            gdcDetailObject.FieldbyName("TO_USR$INV_SELLNDS").asCurrency  = CINT(Left(Sh.Cells(pStartLine, pVatPerc).Value,2))
          end if
         ' gdcDetailObject.FieldbyName("TO_USR$INV_COSTRETAILNCU").asCurrency  = Sh.Cells(pStartLine, pSellCost).Value
          gdcDetailObject.Post
          gdcDetailObject.GotoBookMark(BookMark)
          gdcDetailObject.EnableControls
          gdcDetailObject.cLOSEoPEN
        end sub
        
        function LegalTypeValue(vl,vType)
          select case vType
            case 1
              vl = Replace(vl, "'","")
            case else
              vl = Replace(vl, ",",".")
          end select
            
          LegalTypeValue =vl
        end function
        
        function findCountry(ibSQL, Sh)
         findCountry = null
         ibSQL.Close
         ibSQL.SQL.Text = _
         "SELECT FIRST(1) ID FROM GD_PLACE WHERE PLACETYPE = 'Страна' AND UPPER(NAME) = UPPER(:COUNTRY)"
         ibSQL.ParamByName("COUNTRY").asString = Trim(Sh.Cells(pStartLine, pCountry).Value)
         ibSQL.ExecQuery
         if not ibSQL.EOF Then
            findCountry = ibSQL.FieldByName("ID").asInteger
         end if
        end function
        
        function findGood(Creator, tr, goodname, barcode, alias, descr)
          findGood = null
          ' долно венуть GOODKEY или найденного или вновь вставленного
        
            if len(goodname)>60 Then
        
              dim arrG, Gname
              arrG = Split(goodname,",")
              Gname = arrG(0)
            else
              Gname = goodname
            end if
        
        
            dim gGood,  gdcGood
            set gGood = Creator.GetObject(nil, "TIBSQL", "")
            gGood.Transaction = tr
            gGood.SQL.TExt = _
            "EXECUTE BLOCK( " & _
            "GNAME VARCHAR(60) =:GNAME, " & _
            "GBARCODE VARCHAR(24) =:GBARCODE, " & _
            "GALIAS VARCHAR(16) =:GALIAS, " & _
            "GDESCRIPTION VARCHAR(180)=:GDESCRIPTION) " & _
            "RETURNS( " & _
            "GOODKEY INTEGER) " & _
            "      as " & _
            "DECLARE VARIABLE GKEY INTEGER; " & _
            "DECLARE VARIABLE NewID INTEGER; " & _
            "BEGIN " & _
            "GKEY = null; " & _
            "NewID = null; " & _
            "  SELECT " & _
            "  g.ID " & _
            "  FROM GD_GOOD g " & _
            "  where  UPPER(g.NAME) like '%' || :GNAME || '%' " & _
            "  INTO :GKEY; " & _
            "  GOODKEY = GKEY; " & _
            "  IF (:GKEY is NUll) THEN " & _
            "   BEGIN " & _
            "    SELECT " & _
            "       GEN_ID(gd_g_unique, 1) + GEN_ID(gd_g_offset, 0) " & _
            "    FROM RDB$DATABASE " & _
            "    INTO :NewID; " & _
            "    " & _
            "    INSERT INTO GD_GOOD(id, NAME,VALUEKEY, GROUPKEY/*,BARCODE,DESCRIPTION,ALIAS*/) " & _
            "       VALUES(:NewID,:GNAME,3000001, 154479276/*,:GBARCODE,:GDESCRIPTION,:GALIAS*/); " & _
            "        " & _
            "    GOODKEY = NewID; " & _
            "   END " & _
            "  SUSPEND; " & _
            "END "
           gGood.ParamByName("GNAME").asString = Gname
           gGood.ParamByName("GBARCODE").asString =""
           gGood.ParamByName("GALIAS").asString = ""
           gGood.ParamByName("GDESCRIPTION").asString =LEFT(RIGHT(goodname, LEN(goodname)-LEN(Gname)),180)
           gGood.ExecQuery
        
          findGood = gGood.FieldBYName("GOODKEY").asInteger
        end function
        
        sub arr_goodinfo(goodname)
           arr_goodinfo
           dim arrG
           set arrG = Split(goodname,",")
           
        end sub
        
        
        
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "154577838_1631104572 Imff_findgood"
          - 
            ADDFUNCTIONKEY: "154566984_1631104572 Imff_setParams"