%YAML 1.1
--- 
StructureVersion: "1.0"
Properties: 
  RUID: 149234579_1638717063
  Name: "Import_Empl_DBF"
  Caption: "Import_Empl_DBF"
  Version: "1.0.0.7"
  Optional: False
  Internal: True
  MD5: 9D1045D46F86EBC1AC06FD78F7514A02
Objects: 
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 149234205_1638717063
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      NAME: "Import_Empl_DBF"
      COMMENT: ~
      EVENT: ~
      FUNCTIONTYPE: ~
      GROUPNAME: ~
      INHERITEDRULE: 0
      LANGUAGE: "VBScript"
      LOCALNAME: ~
      MODIFYDATE: ~
      MODULE: "UNKNOWN"
      MODULECODE: "1010001_17 APPLICATION"
      OBJECTNAME: "APPLICATION"
      OWNERNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      USEDEBUGINFO: 0
      EDITIONDATE: 2022-04-13T12:41:00+03:00
      DISPLAYSCRIPT: | 
        IMPORT_EMPL_DBF
        EXCEPTION_IMPORT_EMPL_DBF
        
      ENTEREDPARAMS: ~
      SCRIPT: | 
        '#include GS_GETCONSTBYIDANDDATE
        '#include EXPORTSTAFFCARD
        Option Explicit
        Sub Import_Empl_DBF
        
          dim Creator, objConnection, objCommandWares
          set Creator = new TCreator
          
          
          dim FileName
          FileName = "Sotr.DBF" 'OpenDialog.FileName
        
          dim FSO
          set FSO = CreateObject("Scripting.FileSystemObject")
        
          dim Path
        '  Path = FSO.GetParentFolderName(FileName)
          Path = "\\folders\FOLDERS\23 Обмен (очистка каждое воскренье)\гедемин\"
          
          set objConnection = CreateObject("ADODB.Connection")
          objConnection.Provider = "Microsoft.Jet.OLEDB.4.0"
          objConnection.Properties("Data Source") = Path
          objConnection.Properties("Jet OLEDB:Engine Type") = 18
          objConnection.Open
        
          dim objADOQuery
          set objADOQuery = CreateObject("ADODB.RecordSet")
          objADOQuery.ActiveConnection = objConnection
          objADOQuery.Open " SELECT  * FROM " &  FileName & " WHERE NOT NUMPROPUSK is NULL ", objConnection
          if objADOQuery.EOF then
            objADOQuery.Close
            exit sub
          end if
          
          dim T, ibSQL
          set T = Creator.GetObject(nil, "TIBTransaction", "Import_Empl_DBF")
          set T.DefaultDatabase = gdcBaseManager.DataBase
          call T.Params.Add("read_committed")
          call T.Params.Add("rec_version")
          call T.Params.Add("nowait")
          T.StartTransaction
        
          Except Exception_Import_Empl_DBF(T)
        
          dim TabNum,LASTNAME, NAME, MIDNAME, DPRI,DUVOL, NUMPROPUSK
          Dim WgPos, gdcContact , LimitSum
          
          LimitSum = gs_GetConstByIDAndDate(gdcBaseManager.GetidByRUIDString("161474500_1655689185"), FormatDateTime(now, vbShortDate))
          
          set WgPos = Creator.GetObject(NULL, "TgdcWgPosition", "")
          WgPos.ReadTransaction = T
          WgPos.Transaction = T
          WgPos.SubSet = "All"
          WgPos.Open
        
          set gdcContact = Creator.GetObject(NULL, "TgdcEmployee", "")
          gdcContact.Transaction = T
          '    gdcContact.SubType = "ById"
          gdcContact.Open
        
          dim DiscID, gdcDiscount , ConID
          set gdcDiscount = Creator.GetObject(NULL, "TgdcAttrUserDefined", "")
          gdcDiscount.Transaction = T
          gdcDiscount.SubType = "USR$PF_STAFFCARD"
          gdcDiscount.Open
          
           'патрэбна рабіць адразу і фаміраванне лімітаў
          Dim FormLimit
          set FormLimit = Creator.GetObject(NULL, "TgdcAttrUserDefined", "")
          FormLimit.Transaction = T
          FormLimit.SubType = "USR$MN_FORMATION_LIMIT"
          FormLimit.Open
          
          Dim MnLimit
          set MnLimit = Creator.GetObject(NULL, "TgdcAttrUserDefined", "")
          MnLimit.Transaction = T
          MnLimit.SubType = "USR$MN_LIMIT"
          MnLimit.Open
          
            
          objADOQuery.MoveFirst
          
          while not objADOQuery.EOF
            If Not gdcDiscount.Active Then gdcDiscount.Open
            
            TabNum = CINT(objADOQuery.Fields("TABNUMBER").Value)
            LASTNAME = objADOQuery.Fields("LASTNAME").Value
            NAME = objADOQuery.Fields("NAME").Value
            MIDNAME = objADOQuery.Fields("MIDNAME").Value
            DPRI = objADOQuery.Fields("DPRI").Value
            DUVOL = objADOQuery.Fields("DUVOL").Value
            IF  isNull(DUVOL) then DUVOL = DateSerial(2030,12,31)
            NUMPROPUSK = objADOQuery.Fields("NUMPROPUSK").Value
            
            
            ' не знайшлі картку по ТАБ.НУМАРУ = НУМАРУ КАРТКІ => ТРЭБА СТВАРЫЦЬ
            IF not gdcDiscount.Locate("USR$NUMBER", Array(TabNum), "") Then
              ' адразу знойдзем супрацоўніка
              If gdcContact.Locate("usr$tabnum", Array(TabNum), "") Then
                ConID = gdcContact.ID
                gdcDiscount.Append
                gdcDiscount.FieldByName("USR$NUMBER").asString = CSTR(TabNum)
                gdcDiscount.FieldByName("USR$CODE").asString = NUMPROPUSK
                gdcDiscount.FieldByName("USR$CONTACTKEY").asINTEGER = ConID
                gdcDiscount.Post
                
              else
             '   msgbox "Няма звестак па гэтаму табельнаму нумару:" & CSTR(TabNumber)
                gdcContact.Append
                gdcContact.FieldByName("SURNAME").asString = LASTNAME
                gdcContact.FieldByName("FIRSTNAME").asVariant = NAME
                gdcContact.FieldByName("MIDDLENAME").asVariant = MIDNAME
                gdcContact.FieldByName("NICKNAME").asString = Left(TRIM(NAME),1) & "." & Left(TRIM(MIDNAME),1) & "." & Trim(LASTNAME)
                gdcContact.FieldByName("NAME").asString = Trim(LASTNAME) & " " & Trim(NAME) & " " & Trim(MIDNAME)
                gdcContact.FieldByName("USR$TABNUM").asString = CSTR(int(TabNum))
                gdcContact.FieldByName("PARENT").asVariant = gdcBaseManager.GetIDByRUIDString("149256615_1606276715")
                gdcContact.Post
                ConID = gdcContact.ID
                gdcDiscount.Append
                gdcDiscount.FieldByName("USR$NUMBER").asString = CSTR(TabNum)
                gdcDiscount.FieldByName("USR$CODE").asString = NUMPROPUSK
                gdcDiscount.FieldByName("USR$CONTACTKEY").asINTEGER = ConID
                gdcDiscount.Post
              end if
              
              IF NOT FormLimit.Locate("USR$CONTACTKEY", ConID, "") Then
                FormLimit.Append
                FormLimit.FieldByName("USR$DEPARTMENTTYPEKEY").asInteger = gdcBaseManager.GetIDBYRuidString("149812188_1606276715")
                FormLimit.FieldByName("USR$SUMMA").asVariant = LimitSum
                FormLimit.FieldByName("USR$DATEBEGIN").asDateTime= DateSerial(year(now),01,01)
                FormLimit.FieldByName("USR$DATEEND").asDateTime= DateSerial(year(now),12,31)
                FormLimit.FieldByName("USR$CONTACTKEY").asInteger =ConID
                FormLimit.Post
              END IF
        
              IF NOT MnLimit.Locate("USR$CONTACTKEY", ConID, "") Then
                MnLimit.Append
                MnLimit.FieldByName("USR$DEPARTMENTTYPEKEY").asInteger = gdcBaseManager.GetIDBYRuidString("149812188_1606276715")
                MnLimit.FieldByName("USR$SUMMA").asVariant = LimitSum
                MnLimit.FieldByName("USR$BALANCE").asVariant = LimitSum
                MnLimit.FieldByName("USR$SUM_DATEBEGIN").asDateTime= DateSerial(year(now),MONTH(now),01)
                MnLimit.FieldByName("USR$SUM_DATEEND").asDateTime= DateSerial(year(now),MONTH(now)+1,01)-1
                MnLimit.FieldByName("USR$CONTACTKEY").asInteger =ConID
                MnLimit.Post
              END IF
              DiscID = gdcDiscount.FieldByName("ID").asInteger
            ELSE
              ' знайшлі карту - трэба праверыць тэрмін дзеяння
              IF DUVOL<=CDATE(FormatDateTime(now, vbShortDate)) Then
                gdcDiscount.Edit
                gdcDiscount.FieldByName("USR$DISABLED").asInteger = 1
                gdcDiscount.Post
              END IF
              ' таксама на наяўнасць ліміту
        
              IF NOT MnLimit.Locate("USR$CONTACTKEY", gdcDiscount.FieldByName("USR$CONTACTKEY").AsInteger, "") Then
                MnLimit.Append
                MnLimit.FieldByName("USR$DEPARTMENTTYPEKEY").asInteger = gdcBaseManager.GetIDBYRuidString("149812188_1606276715")
                MnLimit.FieldByName("USR$SUMMA").asVariant = LimitSum
                MnLimit.FieldByName("USR$BALANCE").asVariant = LimitSum
                MnLimit.FieldByName("USR$SUM_DATEBEGIN").asDateTime= DateSerial(year(now),MONTH(now),DAY(now))
                MnLimit.FieldByName("USR$SUM_DATEEND").asDateTime= DateSerial(year(now),MONTH(now)+1,01)-1
                MnLimit.FieldByName("USR$CONTACTKEY").asInteger =gdcDiscount.FieldByName("USR$CONTACTKEY").AsInteger
                MnLimit.Post
              END IF
            END IF
          objADOQuery.MoveNext
          wend
          IF T.InTransaction Then T.Commit
          
          objConnection.Close
          Set objConnection = Nothing
          Set objADOQuery = Nothing
          ' передадим на кассу
          call ExportStaffCard(true)
        End Sub
        
        sub Exception_Import_Empl_DBF(T)
          if T.InTransaction then T.Rollback
        end sub
        
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147141414_141998543 gs_GetConstByIDAndDate"
          - 
            ADDFUNCTIONKEY: "149234014_1638717063 ExportStaffCard"